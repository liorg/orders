@model Michal.Project.Models.OrderDetail

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    /*start :my*/
    .priceb {
        color: white;
        font-size: 18px;
        font-weight: 600;
        background-color: yellowgreen;
    }

    .addpresent::after {
        content: "%";
    }

    .addplus:after {
        content: "x";
    }

    .addsimbol::after {
        content: "₪";
    }
    /* end :my*/
    /*
      start:  http://bootsnipp.com/snippets/featured/bootstrap-loan-calculator
        */

    .price-box {
        margin: 0 auto;
        background: #E9E9E9;
        border-radius: 10px;
        padding: 20px 1px;
        /*width: 500px;*/
    }

    .price, .lead p {
        font-weight: 600;
        font-size: 32px;
        display: inline-block;
        line-height: 60px;
        border: 0;
        width: 245px;
    }

    h4.great {
        background: #00ac98;
        margin: 0 0 25px -60px;
        padding: 7px 15px;
        color: #ffffff;
        font-size: 18px;
        font-weight: 600;
        border-radius: 5px;
        display: inline-block;
        -moz-box-shadow: 2px 4px 5px 0 #ccc;
        -webkit-box-shadow: 2px 4px 5px 0 #ccc;
        box-shadow: 2px 4px 5px 0 #ccc;
    }

        h4.great span {
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            display: inline-block;
        }

    .total {
        border-bottom: 1px solid #7f8c8d;
        /*display: inline;
  padding: 10px 5px;*/
        position: relative;
        padding-bottom: 20px;
    }

        .total:before {
            content: "";
            display: inline;
            position: absolute;
            left: 0;
            bottom: 5px;
            width: 100%;
            height: 3px;
            background: #7f8c8d;
            opacity: 0.5;
        }

    .price-slider {
        margin-bottom: 70px;
    }

        .price-slider span {
            font-weight: 200;
            display: inline-block;
            color: #7f8c8d;
            font-size: 13px;
        }

    .form-pricing {
        background: #ffffff;
        padding: 20px;
        border-radius: 4px;
    }

    .price-form {
        background: #ffffff;
        margin-bottom: 10px;
        padding: 20px;
        border: 1px solid #eeeeee;
        /*min-height: 520px;*/
        border-radius: 4px;
        /*-moz-box-shadow:    0 5px 5px 0 #ccc;
    -webkit-box-shadow: 0 5px 5px 0 #ccc;
    box-shadow:         0 5px 5px 0 #ccc;*/
    }

    .form-group {
        margin-bottom: 0;
    }

        .form-group span.price {
            font-weight: 200;
            display: inline-block;
            color: #7f8c8d;
            font-size: 14px;
        }

    .help-text {
        display: block;
        margin-top: -10px;
        margin-bottom: 10px;
        color: #737373;
        /*position: absolute;*/
        /*margin-left: 20px;*/
        font-weight: 200;
        /*text-align: right;*/
        width: 188px;
    }

    .price-form label {
        font-weight: 200;
        font-size: 21px;
    }

    img.payment {
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    .ui-slider-range-min {
        background: #2980b9;
    }

    .active-month,
    .active-term {
        background: #3276b1;
    }

    /* HR */

    hr.style {
        margin-top: 0;
        border: 0;
        border-bottom: 1px dashed #ccc;
        background: #999;
    }

    /*
      end:  http://bootsnipp.com/snippets/featured/bootstrap-loan-calculator
        */
    /*
      start:  http://bootsnipp.com/snippets/featured/admin-lists-panel
        */
    .trash {
        color: rgb(209, 91, 71);
    }

    .flag {
        color: rgb(248, 148, 6);
    }

    .panel-body {
        padding: 0px;
    }

    .panel-footer .pagination {
        margin: 0;
    }

    .panel .glyphicon, .list-group-item .glyphicon {
        margin-left: 5px;
    }

    .panel-body .radio, .checkbox {
        display: inline-block;
        margin: 0px;
    }

    .panel-body input[type=checkbox]:checked + label {
        text-decoration: line-through;
        color: rgb(128, 144, 160);
    }

    .list-group-item:hover, a.list-group-item:focus {
        text-decoration: none;
        background-color: rgb(245, 245, 245);
    }

    .list-group {
        margin-bottom: 0px;
    }
    /*
      end:  http://bootsnipp.com/snippets/featured/admin-lists-panel
        */
</style>

<div class="row">
    <div class="  col-md-12 well well-lg ">
        <div class="btn-group" style="margin-left: 4px">
            <button type="button" id="btnEdit" data-toggle="tooltip" title="שמור" data-placement="top"
                class="btn btn-success btn-circle btn-xl">
                <img src="~/Content/img/ok32x32.png" />
            </button>
        </div>
        <div class="btn-group" style="margin-left: 4px">
            <button type="button" id="btnCancel" data-toggle="tooltip"  title="ביטול" data-placement="top"
                  data-url="@Url.Action("Index", "F")"  
                class="btn btn-danger btn-circle btn-xl">
                <img src="~/Content/img/delete32x32.png" />
            </button>
        </div>
        <div class="btn-group" style="margin-left: 4px">
            <button type="button" id="btnBack"   data-toggle="tooltip"  title="חזרה" data-placement="top"  data-url="@Url.Action("Index", "F")" 
            class="btn btn-primary btn-circle btn-xl">
                <img src="~/Content/img/back32x32.png" />
            </button>
        </div>
    </div>
</div>

<div class="panel-group" id="accordion">
    <div class="panel panel-default">

        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseOrder">הצג מחיר מומלץ לצרכן</a>
            </h4>
        </div>

        <div id="collapseOrder" class="panel-collapse collapse in">
            <div class="panel-body">
                <div class="row">
                    <div class="price-box">
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="price-form">
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <label for="amount_amirol" class="control-label">
                                                    <img src="~/Content/img/additem32green.png" />
                                                    מחיר לפני הנחה (₪):
                                                </label>
                                                <span class="help-text">המחיר לפני הנחה לא כולל זמני המתנה</span>
                                            </div>
                                            <div class="col-sm-6">
                                                <input type="hidden" id="amount_amirol" class="form-control">
                                                <!-- <p class="price lead" id="total"></p> -->
                                                <input class="price lead" name="totalprice" type="text" id="total" disabled="disabled" data-bind="value: TotalPrice" style="">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <label for="amount_amirol" class="control-label">
                                                    <img src="~/Content/img/discount32green.png" />
                                                    הנחה (₪):
                                                </label>
                                                <span class="help-text">הנחה כולל עבור הפריטים</span>
                                            </div>
                                            <div class="col-sm-6">
                                                <input type="hidden" id="amount_amirol" class="form-control">
                                                <!-- <p class="price lead" id="total12"></p> -->
                                                <input class="price lead" name="totalprice12" type="text" id="total12" data-bind="value: TotalDiscount" disabled="disabled" style="">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <label for="amount_amirol" class="control-label">
                                                    <img src="~/Content/img/sum32green.png" />
                                                    סה"כ (₪):
                                                </label>
                                                <span class="help-text">סה"כ המחיר</span>
                                            </div>
                                            <div class="col-sm-6">
                                                <input type="hidden" id="amount_amirol" class="form-control">
                                                <input class="price lead" name="totalprice52" type="text" id="total52" data-bind="value: Total" disabled="disabled" style="">
                                            </div>
                                        </div>
                                    </div>
                                  
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-pricing">
                                    <div class="panel panel-primary ">
                                        <div class="panel-heading">
                                            הצג פרטי ההזמנה 
                                            <!-- ko if: AllowAddDiscount() == true ||  AllowAddItem() ==true -->
                                            <div class="pull-right action-buttons">
                                                <div class="btn-group pull-right">
                                                    <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
                                                        <span class="glyphicon glyphicon-cog" style="margin-right: 0px;"></span>
                                                    </button>
                                                    <ul class="dropdown-menu slidedown">
                                                        <!-- ko if: AllowAddDiscount() == true -->
                                                         <li><a href="#" data-bind="click: createNewItem"><span class="glyphicon glyphicon-plus"></span>הוסף פריט למשלוח</a></li>
                                                        <!-- /ko -->
                                                        <!-- ko if: AllowAddItem() ==true -->
                                                        <li><a href="#" data-bind="click: createNewDiscount"><span class="glyphicon glyphicon-plus"></span>הוסף הנחה</a></li>
                                                        <!-- /ko -->
                                                     </ul>

                                                </div>
                                            </div>
                                        <!-- /ko -->
                                        </div>
                                        <div class="panel-body">
                                            <ul class="list-group" data-bind="foreach: Items">
                                                <li class="list-group-item">
                                                    <!-- ko if: IsDiscount() ==true -->
                                                    <img class="pull-right" src="~/Content/img/percent16.png" />
                                                    <!-- /ko -->
                                                    <i data-bind="text: Name"></i>
                                                    <!-- ko if: Amount()>1-->
                                                    <b class="addplus" data-bind="text: Amount"></b>
                                                    <!-- /ko -->
                                                    @*<span class="pull-right badge">5</span>*@
                                                    <!-- ko if: HasPrice()==false -->
                                                    <span style="color: white; font-size: 18px; font-weight: 600; background-color: red" class="badge pull-left">אן מחיר</span>
                                                    <!-- /ko -->
                                                    <!-- ko if: HasPrice()==true -->
                                                    <span style="color: white; font-size: 18px; font-weight: 600; background-color: yellowgreen" class="badge pull-left addsimbol" data-bind="text: PriceValue, css: { 'addpresent': IsPresent() == true, 'addsimbol': IsPresent() == false }"></span>
                                                    <!-- /ko -->
                                                    <div class="pull-left action-buttons">
                                                        <!-- ko if: AllowEdit() ==true -->
                                                        <a href="#" data-bind="click: $parent.openModal"><span class="glyphicon glyphicon-pencil"></span></a>
                                                        <!-- /ko -->
                                                        <!-- ko if: AllowRemove() ==true -->
                                                        <a href="#" class="trash"><span class="glyphicon glyphicon-trash"></span></a>
                                                        <!-- /ko -->
                                                    </div>
                                                </li>

                                            </ul>
                                        </div>
                                        <div class="panel-footer">
                                            <div class="row">
                                                <div class="col-md-6">
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">הצג כתובות יעד והמקור</a>
                </h4>
            </div>
            <div id="collapseOne" class="panel-collapse collapse">
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-6 col-lg-6 col-xs-12 col-sm-12">
                            <ul class="list-group">

                                <li class="list-group-item">
                                    <span class="label label-success">@Html.Partial("_addressView", Model.SourceAddress)</span>
                                    <span class="prefix  pull-right">כתובת השולח:</span>
                                </li>

                            </ul>
                        </div>
                        <div class="col-md-6 col-lg-6 col-xs-12 col-sm-12">
                            <ul class="list-group">
                                <li class="list-group-item">
                                    <span class="label label-danger">@Html.Partial("_addressView", Model.TargetAddress) </span>
                                    <span class="prefix  pull-right">כתובת היעד:</span>
                                </li>

                            </ul>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">שדות חישוב</a>
                </h4>
            </div>
            <div id="collapseTwo" class="panel-collapse collapse">
                <div class="panel-body">
                    <div class="row">
                        
                    </div>
                </div>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseTree">מוצרי המשלוח</a>
                </h4>
            </div>
            <div id="collapseTree" class="panel-collapse collapse">
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-3"></div>
                        <div class="col-md-9">
                            <table class=" table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Author</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                   <td></td>
                                    <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {

    @Scripts.Render("~/api/OfferService/GetOffer?shipid=" + Model.Id + "&offerId=" + Guid.Empty)
    <script src="~/Scripts/knockout-3.3.0.js"></script>
    <script src="~/Scripts/knockout.mapping-latest.js"></script>

    <script>
        ko.bindingHandlers.modal = {
            init: function (element, valueAccessor) {
                $(element).modal({
                    show: false
                });

                var value = valueAccessor();
                if (ko.isObservable(value)) {
                    $(element).on('hide.bs.modal', function () {
                        value(false);
                    });
                }
                ko.utils.domNodeDisposal.addDisposeCallback(element, function () {
                    $(element).modal("destroy");
                });

            },
            update: function (element, valueAccessor, allBindingsAccessor) {
                var value = valueAccessor();
                //http://jsfiddle.net/YmQTW/1/
                var shouldBeOpen = ko.utils.unwrapObservable(allBindingsAccessor().dialogVisible);
                //if (ko.utils.unwrapObservable(value)) 
                if (shouldBeOpen) {
                    $(element).modal('show');
                } else {
                    $(element).modal('hide');
                }
            }
        }

        function generateUUID() {
            var d = new Date().getTime();
            var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = (d + Math.random() * 16) % 16 | 0;
                d = Math.floor(d / 16);
                return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
            return uuid;
        };
    </script>

    <script>
        function OfferItem(id, name, desc, priceValue,
            isPresent, isDiscount, statusRecord, amount,
            hasPrice, allowEdit, allowRemove, allowCancel,
            objectId, objectIdType
            ) {
            this.Id = ko.observable(id);
            this.Name = ko.observable(name);
            this.Desc = ko.observable(desc);
            this.PriceValue = ko.observable(priceValue);

            this.IsPresent = ko.observable(isPresent);
            this.IsDiscount = ko.observable(isDiscount);
            this.StatusRecord = ko.observable(statusRecord);
            this.Amount = ko.observable(amount);

            this.HasPrice = ko.observable(hasPrice);
            this.AllowEdit = ko.observable(allowEdit);
            this.AllowRemove = ko.observable(allowRemove);
            this.AllowCancel = ko.observable(allowCancel);

            this.ObjectId = ko.observable(objectId);
            this.ObjectIdType = ko.observable(objectIdType);

            this.ObjectId.subscribe(function (newId) {
                // debugger;
                var newProduct = null;

                if (this.IsDiscount()) {
                    newProduct = ko.utils.arrayFirst(vm.Discounts(), function (item) {
                        return item.Id == newId;
                    });
                }

                if (newProduct != null) {
                    this.Name(newProduct.Name);
                    this.Desc(newProduct.Desc);
                }
            }.bind(this));
        };

        var vm = new AppViewModel(offerClient);

        function AppViewModel(vmData) {
            var self = this;
            self.isOpen = ko.observable(false);
            self.Items = ko.mapping.fromJS(vmData.Items);
            self.Discounts = ko.observableArray(vmData.Discounts);
            self.DirtyDiscounts = ko.observableArray();
            self.AllowAddItem = ko.observable(vmData.AllowAddItem);
            self.AllowAddDiscount = ko.observable(vmData.AllowAddDiscount);

            self.currentModalItem = ko.observable(null);

            self.cancelOffer = function (f) {
                alert(f.Id);
            };

            self.TotalDiscount = ko.computed(function () {
                var count = getTotalDiscount();
                if (count != null) return count.toFixed(2);
                return count;
            });

            self.TotalPrice = ko.computed(function () {
                var count = getTotalPrice();
                if (count != null) return count.toFixed(2);
                return count;
            });

            function getTotalPrice() {
                var count = 0;
                for (var i = 0; i < self.Items().length; i++) {

                    if (self.Items()[i].IsDiscount() == true) continue;
                    if (self.Items()[i].PriceValue() == null) {
                        count = null;
                        break;
                    }
                    count += parseFloat(self.Items()[i].PriceValue());
                }
                return count;
            }

            function getTotalDiscount(total) {
                var total = total || getTotalPrice();
                var count = 0;
                var countPersent = 0;
                var result = 0;
                if (total == null) return null;

                for (var i = 0; i < self.Items().length; i++) {
                    var item = self.Items()[i];
                    if (item.IsDiscount() == false) continue;
                    if (item.PriceValue() == null) {
                        count = null;
                        break;
                    }
                    if (item.IsPresent() == true) {
                        countPersent += parseFloat(item.PriceValue());
                    }
                    else {
                        count += parseFloat(item.PriceValue());
                    }

                }
                if (countPersent == null && count == null)
                    return null;
                result = ((total * (countPersent / 100)) + count);

                return result;
            }

            self.Total = ko.computed(function () {
                var totalPrice = getTotalPrice();
                if (totalPrice == null) return null;
                var totalDiscount = getTotalDiscount(totalPrice);
                if (totalDiscount == null) return null;
                return totalPrice - totalDiscount;
            });

            self.createNewItem = function (item) {
                self.isOpen(true);
                var newt = new OfferItem("00000000-0000-0000-0000-000000000000", "new", "", null,
                        false, false, 3, 1,
                        false, true, true, true, "00000000-0000-0000-0000-000000000000", "1");
                self.currentModalItem(newt);
            };

            self.createNewDiscount = function (item) {
                self.isOpen(true);
                var newt = new OfferItem("00000000-0000-0000-0000-000000000000", "new", "", null,
                    true, true, 3, 1,
                    false, true, true, true, "00000000-0000-0000-0000-000000000000", "99");
                self.currentModalItem(newt);
            };

            self.openModal = function (item) {
                self.isOpen(true);
                if (item instanceof AppViewModel) {
                    //var it = { "ObjectId": "00000000-0000-0000-0000-000000000000", "ObjectIdType": 2, "Id": "00000000-0000-0000-0000-000000000000", "Name": "...", "Desc": "....", "PriceValue": 10.0, "IsPresent": false, "IsDiscount": true, "StatusRecord": 3, "Amount": 1, "HasPrice": true, "AllowEdit": true, "AllowRemove": true, "AllowCancel": true };
                    var newt = new OfferItem("00000000-0000-0000-0000-000000000000", "new", "new desc", null,
                        true, true, 3, 1,
                        false, true, true, true, "00000000-0000-0000-0000-000000000000", "99");
                    self.currentModalItem(newt);
                }
                else {
                    var editt = new OfferItem(item.Id(), item.Name(), item.Desc(), item.PriceValue(),
                        item.IsPresent(), item.IsDiscount(), item.StatusRecord(), item.Amount(),
                        item.HasPrice(), item.AllowEdit(), item.AllowRemove(), item.AllowCancel(),
                        item.ObjectId(), item.ObjectIdType());

                    self.currentModalItem(editt);
                }

            };

            self.save = function () {
                debugger;
                var current = self.currentModalItem();
                if (current.StatusRecord() == 1 || current.StatusRecord() == 4) {
                    product = ko.utils.arrayFirst(vm.Items(), function (item) {
                        return item.Id() == current.Id();
                    });
                    if (product != null) {
                        product.PriceValue(current.PriceValue());
                        product.HasPrice(true);
                    }
                }
                else {
                    var item = {};
                    item.Id = generateUUID();
                    item.Name = current.Name();
                    item.Desc = current.Desc();
                    item.PriceValue = current.PriceValue();
                    item.IsPresent = current.IsPresent();
                    item.IsDiscount = current.IsDiscount();
                    item.StatusRecord = 4;
                    item.Amount = current.Amount();

                    item.HasPrice = current.PriceValue() != null && current.PriceValue() != "";
                    item.AllowEdit = current.AllowEdit();
                    item.AllowRemove = current.AllowRemove();
                    item.AllowCancel = current.AllowCancel();

                    item.ObjectId = current.ObjectId();
                    item.ObjectIdType = current.ObjectIdType();
                    var ob = ko.mapping.fromJS(item);

                    //  debugger;
                    var dd = self.Items;
                    dd.push(ob);
                    // var dd = vm.Items;
                    //dd.push(ob);

                    var discount = ko.utils.arrayFirst(vm.Discounts(), function (discountItem) {
                        return discountItem.Id == item.ObjectId;
                    });
                    if (discount != null) {
                        var disounts = self.Discounts;

                        var dirtydis = self.DirtyDiscounts;
                        dirtydis.push(discount);
                        disounts.remove(discount);
                    }

                }
                self.isOpen(false);
            }
        };

        ko.applyBindings(vm);

    </script>
}
<!--http://jsfiddle.net/YmQTW/1/ -->
<div class="modal fade" data-bind="modal: !!currentModalItem(), with: currentModalItem, dialogVisible: isOpen">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title" data-bind="text: Name"></h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-md-2 control-label" for="DistanceId">שם:</label>
                        <div class="col-md-6">

                            <!-- ko if: IsDiscount() ==true && StatusRecord() ==3-->
                            <select class="form-control" data-bind=" options: $parent.Discounts,
    optionsText: 'Name', optionsValue: 'Id', value: ObjectId,
    optionsCaption: 'בחר הנחה...'">
                            </select>
                            <!-- /ko -->
                            <!-- ko if: StatusRecord() !=3-->
                            <input type="text" data-bind="textInput: Name" />
                            <i></i>
                            <!-- /ko -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-2 control-label" for="DistanceId">מחיר:</label>
                        <div class="col-md-6">
                            <input data-bind="textInput: PriceValue" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-2 control-label" for="DistanceId">כמות:</label>
                        <div class="col-md-6">
                            <input data-bind="textInput: Amount" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-2 control-label" for="DistanceId">תיאור:</label>
                        <div class="col-md-6">
                            <input data-bind="textInput: Desc" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-xs" data-bind="click: $parent.save">שמור</button>
            </div>
        </div>
    </div>
</div>
