@model Michal.Project.Models.OrderDetail

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    /*
        http://bootsnipp.com/snippets/featured/bootstrap-loan-calculator
        */

    .price-box {
        margin: 0 auto;
        background: #E9E9E9;
        border-radius: 10px;
        padding: 20px 1px;
        /*width: 500px;*/
    }

    .price, .lead p {
        font-weight: 600;
        font-size: 32px;
        display: inline-block;
        line-height: 60px;
        border: 0;
        width: 245px;
    }

    h4.great {
        background: #00ac98;
        margin: 0 0 25px -60px;
        padding: 7px 15px;
        color: #ffffff;
        font-size: 18px;
        font-weight: 600;
        border-radius: 5px;
        display: inline-block;
        -moz-box-shadow: 2px 4px 5px 0 #ccc;
        -webkit-box-shadow: 2px 4px 5px 0 #ccc;
        box-shadow: 2px 4px 5px 0 #ccc;
    }

        h4.great span {
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            display: inline-block;
        }

    .total {
        border-bottom: 1px solid #7f8c8d;
        /*display: inline;
  padding: 10px 5px;*/
        position: relative;
        padding-bottom: 20px;
    }

        .total:before {
            content: "";
            display: inline;
            position: absolute;
            left: 0;
            bottom: 5px;
            width: 100%;
            height: 3px;
            background: #7f8c8d;
            opacity: 0.5;
        }

    .price-slider {
        margin-bottom: 70px;
    }

        .price-slider span {
            font-weight: 200;
            display: inline-block;
            color: #7f8c8d;
            font-size: 13px;
        }

    .form-pricing {
        background: #ffffff;
        padding: 20px;
        border-radius: 4px;
    }

    .price-form {
        background: #ffffff;
        margin-bottom: 10px;
        padding: 20px;
        border: 1px solid #eeeeee;
        min-height: 520px;
        border-radius: 4px;
        /*-moz-box-shadow:    0 5px 5px 0 #ccc;
    -webkit-box-shadow: 0 5px 5px 0 #ccc;
    box-shadow:         0 5px 5px 0 #ccc;*/
    }

    .form-group {
        margin-bottom: 0;
    }

        .form-group span.price {
            font-weight: 200;
            display: inline-block;
            color: #7f8c8d;
            font-size: 14px;
        }

    .help-text {
        display: block;
        margin-top: -10px;
        margin-bottom: 10px;
        color: #737373;
        /*position: absolute;*/
        /*margin-left: 20px;*/
        font-weight: 200;
        /*text-align: right;*/
        width: 188px;
    }

    .price-form label {
        font-weight: 200;
        font-size: 21px;
    }

    img.payment {
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    .ui-slider-range-min {
        background: #2980b9;
    }

    .active-month,
    .active-term {
        background: #3276b1;
    }

    /* HR */

    hr.style {
        margin-top: 0;
        border: 0;
        border-bottom: 1px dashed #ccc;
        background: #999;
    }

    /*my*/
    .priceb {
        color: white;
        font-size: 18px;
        font-weight: 600;
        background-color: yellowgreen;
    }

    .addpresent::after {
        content: "%";
    }

    .addsimbol::after {
        content: "₪";
    }
</style>

<div class="row">
    <div class="  col-md-12 well well-lg ">
        <div class="btn-group" style="margin-left: 4px">
            <button type="button" id="btnEdit" data-toggle="tooltip" title="שמור" data-placement="top"
                class="btn btn-success btn-circle btn-xl">
                <img src="~/Content/img/ok32x32.png" />
            </button>
        </div>
        <div class="btn-group" style="margin-left: 4px">
            <button type="button" id="btnCancel" data-toggle="tooltip"  title="ביטול" data-placement="top"
                  data-url="@Url.Action("Index", "F")"  
                class="btn btn-danger btn-circle btn-xl">
                <img src="~/Content/img/delete32x32.png" />
            </button>
        </div>
        <div class="btn-group" style="margin-left: 4px">
            <button type="button" id="btnBack"   data-toggle="tooltip"  title="חזרה" data-placement="top"  data-url="@Url.Action("Index", "F")" 
            class="btn btn-primary btn-circle btn-xl">
                <img src="~/Content/img/back32x32.png" />
            </button>
        </div>
    </div>
</div>

<div class="panel-group" id="accordion">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseOrder">פרטים</a>
            </h4>
        </div>
        <div id="collapseOrder" class="panel-collapse collapse in">
            <div class="panel-body">
                  <div class="row">
   <div class="price-box">
    <div class="row">
        <div class="col-sm-6">
            <div class="price-form">
                <div class="form-group">
                    <div class="row">
                        <div class="col-sm-6">
                            <label for="amount_amirol" class="control-label">
                                <img src="~/Content/img/additem32green.png" />
                                מחיר לפני הנחה (₪):
                            </label>
                            <span class="help-text">המחיר לפני הנחה לא כולל זמני המתנה</span>
                        </div>
                        <div class="col-sm-6">
                            <input type="hidden" id="amount_amirol" class="form-control">
                            <!-- <p class="price lead" id="total"></p> -->
                            <input class="price lead" name="totalprice" type="text" id="total" disabled="disabled"  data-bind="value: TotalPrice" style="">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="row">
                        <div class="col-sm-6">
                            <label for="amount_amirol" class="control-label">
                                <img src="~/Content/img/discount32green.png" />
                                הנחה (₪):
                            </label>
                            <span class="help-text">הנחה כולל עבור הפריטים</span>
                        </div>
                        <div class="col-sm-6">
                            <input type="hidden" id="amount_amirol" class="form-control">
                            <!-- <p class="price lead" id="total12"></p> -->
                            <input class="price lead" name="totalprice12" type="text" id="total12" data-bind="value: TotalDiscount" disabled="disabled" style="">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="row">
                        <div class="col-sm-6">
                            <label for="amount_amirol" class="control-label">
                                <img src="~/Content/img/sum32green.png" />
                              סה"כ (₪):
                            </label>
                            <span class="help-text">סה"כ המחיר</span>
                        </div>
                        <div class="col-sm-6">
                            <input type="hidden" id="amount_amirol" class="form-control">
                            <input class="price lead" name="totalprice52" type="text" id="total52" data-bind="value: Total" disabled="disabled" style="">
                        </div>
                    </div>
                </div>
                <div style="margin-top: 30px"></div>
                <hr class="style">
                <div class="form-group">
                    <div class="col-sm-6">
                        <button   data-bind="click: openModal" 
                            class="btn btn-primary btn-lg btn-block">
                            <img src="~/Content/img/sales32.png" />הוסף הנחה</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6">
            <form class="form-horizontal form-pricing" role="form">
                <h4>הצג פריטים</h4>
                <div style="margin-top: 10px"></div>
                <hr class="style">
                <div class="price-slider" data-bind="foreach: Items">
                    <h4 style="width: 100%" class="great">
                        <!-- ko if: IsDiscount() ==false -->
                        <img src="~/Content/img/additem32.png" />
                        <!-- /ko -->
                        <!-- ko if: IsDiscount() ==true -->
                        <img src="~/Content/img/sales32.png" />
                        <!-- /ko -->
                        <span data-bind="text: Name"></span>
                        <!-- ko if: HasPrice()==false -->
                        <span style="color: white; font-size: 18px; font-weight: 600; background-color: red" class="badge pull-left" >אן מחיר</span>
                        <!-- /ko -->
                        <!-- ko if: HasPrice()==true -->
                        <span style="color: white; font-size: 18px; font-weight: 600; background-color: yellowgreen" class="badge pull-left addsimbol" data-bind="text: PriceValue, css: { 'addpresent': IsPresent() == true, 'addsimbol': IsPresent() == false }"></span>
                        <!-- /ko -->
                    </h4>
                    <div class="help-text"><span style="top: 0px" data-bind="text: Desc"></span><br />
                        <span class="btn-group">
                            <a class="xcrud-action btn btn-info btn-sm" <a href="#" data-bind="click: $parent.cancelOffer"
                                title="View" href="javascript:;" data-primary="6" data-task="view"><i class="glyphicon glyphicon-trash"></i></a>
                                <a class="xcrud-action btn btn-warning btn-sm" title="Edit" 
                                    data-bind="click: $parent.openModal" 
                                    href="javascript:;" data-primary="6" data-task="edit"><i class="glyphicon glyphicon-edit "></i></a><a class="xcrud-action btn btn-danger btn-sm" title="Remove" href="javascript:;" data-primary="6" data-task="remove" data-confirm="Do you really want remove this entry?"><i class="glyphicon glyphicon-remove"></i></a></span>
                    </div>

                </div>
            </form>
        </div>
    </div>
        </div>
       </div>
            </div>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">1. כתובת</a>
            </h4>
        </div>
        <div id="collapseOne" class="panel-collapse collapse">
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-6 col-lg-6 col-xs-12 col-sm-12">
                        <ul class="list-group">

                            <li class="list-group-item">
                                <span class="label label-success">@Html.Partial("_addressView", Model.SourceAddress)</span>
                                <span class="prefix  pull-right">כתובת השולח:</span>
                            </li>

                        </ul>
                    </div>
                    <div class="col-md-6 col-lg-6 col-xs-12 col-sm-12">
                        <ul class="list-group">
                            <li class="list-group-item">
                                <span class="label label-danger">@Html.Partial("_addressView", Model.TargetAddress) </span>
                                <span class="prefix  pull-right">כתובת היעד:</span>
                            </li>

                        </ul>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">2. חישוב מחיר</a>
            </h4>
        </div>
        <div id="collapseTwo" class="panel-collapse collapse">
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-3"></div>
                    <div class="col-md-9">
                        <table class=" table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Author</th>
                                </tr>
                            </thead>
                            <tbody data-bind="foreach: Items">
                                <tr>
                                    <td data-bind="text: Name"></td>
                                    <td data-bind="text: PriceValue"></td>
                                    <td><a href="#" data-bind="click: $parent.cancelOffer">Cancel</a></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {

    @Scripts.Render("~/api/OfferService/GetOffer?shipid=" + Model.Id + "&offerId=" + Guid.NewGuid())
    <script src="~/Scripts/knockout-3.3.0.js"></script>
    <script src="~/Scripts/knockout.mapping-latest.js"></script>
    <script>
        ko.bindingHandlers.modal = {
            init: function (element, valueAccessor) {
                $(element).modal({
                    show: false
                });

                var value = valueAccessor();
                if (ko.isObservable(value)) {
                    $(element).on('hide.bs.modal', function () {
                        value(false);
                    });
                }
                ko.utils.domNodeDisposal.addDisposeCallback(element, function () {
                    $(element).modal("destroy");
                });

            },
            update: function (element, valueAccessor) {
                var value = valueAccessor();
                if (ko.utils.unwrapObservable(value)) {
                    $(element).modal('show');
                } else {
                    $(element).modal('hide');
                }
            }
        }
    </script>
    
    <script>
        function OfferItem(id, name, desc, priceValue,
            isPresent, isDiscount, statusRecord, amount,
            hasPrice, allowEdit, allowRemove, allowCancel,
            objectId, objectIdType
            ) {
            this.Id = ko.observable(id);
            this.Name = ko.observable(name);
            this.Desc = ko.observable(desc);
            this.PriceValue = ko.observable(priceValue);

            this.IsPresent = ko.observable(isPresent);
            this.IsDiscount = ko.observable(isDiscount);
            this.StatusRecord = ko.observable(statusRecord);
            this.Amount = ko.observable(amount);

            this.HasPrice = ko.observable(hasPrice);
            this.AllowEdit = ko.observable(allowEdit);
            this.AllowRemove = ko.observable(allowRemove);
            this.AllowCancel = ko.observable(allowCancel);

            this.ObjectId = ko.observable(objectId);
            this.ObjectIdType = ko.observable(objectIdType);

            this.ObjectId.subscribe(function (newId) {
                debugger;
                var newProduct = null;

                if (this.IsDiscount()) {
                    newProduct = ko.utils.arrayFirst(vm.Discounts(), function (item) {
                        return item.Id == newId;
                    });
                }

                if (newProduct != null) {
                    this.Name(newProduct.Name);
                    this.Desc(newProduct.Desc);
                }
            }.bind(this));
        };

        var vm = new AppViewModel(offerClient);
        function AppViewModel(vmData) {
            debugger;
            var self = this;
            self.Items = ko.mapping.fromJS(vmData.Items);

            //self.Items = ko.observableArray(items);
            self.Discounts = ko.observableArray(vmData.Discounts);


            self.currentModalItem = ko.observable(null);
            //self.TotalPrice=
            self.cancelOffer = function (f) {
                alert(f.Id);
            };
            self.TotalDiscount = ko.computed(function () {

                return 212;
            });
            self.TotalPrice = ko.computed(function () {

                return 100;
            });
            self.Total = ko.computed(function () {

                return 1050;
            });


            self.openModal = function (item) {
                // debugger;
                if (item instanceof AppViewModel) {
                    //var it = { "ObjectId": "00000000-0000-0000-0000-000000000000", "ObjectIdType": 2, "Id": "00000000-0000-0000-0000-000000000000", "Name": "...", "Desc": "....", "PriceValue": 10.0, "IsPresent": false, "IsDiscount": true, "StatusRecord": 3, "Amount": 1, "HasPrice": true, "AllowEdit": true, "AllowRemove": true, "AllowCancel": true };
                    var it = new OfferItem("00000000-0000-0000-0000-000000000000", "new", "new desc", null,
                        true, true, 3, 1,
                        false, true, true, true, "00000000-0000-0000-0000-000000000000", "1");

                    self.currentModalItem(it);
                }
                else {

                    var editt = new OfferItem(item.Id(), item.Name(), item.Desc(), item.PriceValue(),
                        item.IsPresent(), item.IsDiscount(), item.StatusRecord(), item.Amount(),
                        item.HasPrice(), item.AllowEdit(), item.AllowRemove(), item.AllowCancel(),
                        item.ObjectId(), item.ObjectIdType());

                    self.currentModalItem(editt);
                    //alert(item.StatusRecord);
                }

            };
            self.save = function () {
                debugger;
                var current = self.currentModalItem();
                if (current.StatusRecord() == 1) {
                    product = ko.utils.arrayFirst(vm.Items(), function (item) {
                        return item.Id() == current.Id();
                    });
                    if (product != null) {
                        product.PriceValue(current.PriceValue());
                        product.HasPrice(true);
                        //     product.PriceValue = current.PriceValue();
                    }

                }
                else {
                    var item = {};
                    item.Id = current.Id()
                    item.Name = current.Name();
                    item.Desc = current.Desc();
                    item.PriceValue = current.PriceValue();

                    item.IsPresent = current.IsPresent();
                    item.IsDiscount = current.IsDiscount();
                    item.StatusRecord = current.StatusRecord();
                    item.Amount = current.Amount();

                    item.HasPrice = current.HasPrice();
                    item.AllowEdit = current.AllowEdit();
                    item.AllowRemove = current.AllowRemove();
                    item.AllowCancel = current.AllowCancel();

                    item.ObjectId = current.ObjectId();
                    item.ObjectIdType = current.ObjectIdType();
                   var ob= ko.mapping.fromJS(item);
                    ////get the underlying array
                   // var myUnderlyingArray = self.Items();
                  //  myUnderlyingArray.push(ob);
                    vm.Items().push(ob);
                }
                //alert('submit');
                self.openModal(null);
            }
           

        };

        ko.applyBindings(vm);

    </script>
}

<div class="modal fade" data-bind="modal: !!currentModalItem(), with: currentModalItem">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title" data-bind="text: Name"></h4>
            </div>
            <div class="modal-body">
                <p>
   בחר סוג
                       <!-- ko if: IsDiscount() ==true && StatusRecord() ==3-->
    <select data-bind=" options: $parent.Discounts,
    optionsText: 'Name', optionsValue: 'Id', value: ObjectId,
    optionsCaption: 'בחר הנחה...'"></select>
                     <!-- /ko -->
                  
                      <!-- ko if: StatusRecord !=3-->

                    <i data-bind="text: Name"></i>
                     <!-- /ko -->
</p>
                <br />
                <p><i data-bind="text: PriceValue"></i></p>
                <p>מחיר: <input data-bind="textInput: PriceValue" /></p>
                 <p><i data-bind="text: Desc"></i></p>
                 <p><i data-bind="text: ObjectId"></i></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-xs" data-bind="click: $parent.save">שמור</button>
            </div>
        </div>
    </div>
</div>

